<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="author" content="Godot Engine">
	<meta name="description" content="Report on the complex text layouts support implementation progress, part one: TextServer interface implementation details.">
	<meta name="theme-color" content="#3d8fcc">
	<meta property="og:site_name" content="Godot Engine">
	<meta property="og:url" content="https://godotengine.org/article/complex-text-layouts-progress-report-1/">
	<meta name="twitter:site" content="@godotengine">

	<meta property="og:title" content="Complex text layouts progress report #1">
	<meta property="og:description" content="Report on the complex text layouts support implementation progress, part one: TextServer interface implementation details.">
	<meta property="og:image" content="https://godotengine.org/storage/app/uploads/public/5f8/6ec/9d7/5f86ec9d7d0fd694122636.png">
	<meta property="og:type" content="article">
	<meta name="twitter:card" content="summary_large_image">
	<title>Complex text layouts progress report #1</title>

	<link rel="alternate" type="application/rss+xml" title="Godot News" href="/rss.xml">
	<link rel="icon" href="/assets/favicon.png" sizes="any">
	<link rel="icon" href="/assets/favicon.svg" type="image/svg+xml">
	<link rel="stylesheet" href="/assets/css/main.css?109">
	<link rel="stylesheet" href="/assets/css/tobii.min.css">
	<link rel="preload" as="font" href="/assets/fonts/Montserrat-Bold.woff2" crossorigin>
	<link rel="preload" as="font" href="/assets/fonts/Montserrat-ExtraBold.woff2" crossorigin>
	<link rel="me" href="https://mastodon.gamedev.place/@godotengine">
</head>

<body>
	<input type="checkbox" id="nav_toggle_cb">
<header>
	<div class="container flex align-center">
		<div id="nav_head">
			<a href="/" id="logo-link">
				<img class="nav-logo" src="/assets/logo.svg" width="136" height="48" alt="Godot Engine">
				<img class="nav-logo dark-logo" src="/assets/logo_dark.svg" width="136" height="48" alt="Godot Engine">
			</a>
			<label for="nav_toggle_cb" id="nav_toggle_btn">
				<img src="/assets/icons/hamburger.svg" width="24" height="24" alt="Main menu">
			</label>
		</div>

		<nav id="nav">
			<ul class="left">
				<li><a href="/features">Features</a></li>
				<div class="only-on-mobile" style="width: 100%">
					<li><a href="/showcase">Showcase</a></li>
				</div>
				<li><a href="/blog">Blog</a></li>
				<li><a href="/community">Community</a></li>
				<li><a href="/contact">About</a></li>
				<li><a href="https://godotengine.org/asset-library/asset">Assets</a></li>
			</ul>

			<ul class="right">
				<li><a href="/download/windows" class="set-os-download-url">Download</a></li>
				<li><a href="https://docs.godotengine.org">Learn</a></li>
				<li><a href="https://docs.godotengine.org/en/stable/community/contributing/index.html">Contribute</a></li>
				
				<li class="fund"><a href="https://fund.godotengine.org">❤&#xFE0E; Donate</a></li>
			</ul>
		</nav>
	</div>
</header>

<main>


<style>
	body {
		background-color: var(--background-color);
	}

	h1 {
		margin-bottom: 8px;
		margin-top: 32px;
	}

	:not(pre)>code {
		background: var(--code-background-color);
		padding: 1px 4px;
		font-size: 0.95em;
		border-radius: 3px;
	}

	pre {
		background: var(--codeblock-background-color);
		color: var(--codeblock-color);
	}

	pre code {
		display: block;
		overflow-x: auto;
		padding: .5em;
	}

	.date-big {
		line-height: 2;
		margin-left: 32px;
	}

	article {
		background-color: var(--base-color);
		box-shadow: 0px 3px 2px 0px rgba(0, 0, 0, 0.15);
	}

	figure {
		margin: 0;
	}

	figure img {
		margin: 0;
	}

	article img,
	article video {
		max-width: 100%;
		height: auto;
		display: block;
		margin: auto;
		margin-top: 16px;
		margin-bottom: 16px;
	}

	article h1 {
		margin-top: 64px;
	}

	article h2,
	article h3,
	article h4 {
		margin-top: 42px;
	}

	.article-info {
		display: flex;
		flex-direction: column;
		gap: 8px;
	}

	.article-metadata {
		display: flex;
		gap: 24px;
		align-items: center;
		font-family: var(--header-font-family);
		margin-bottom: 12px;
	}

	@media (max-width: 900px) {
		.article-metadata {
			flex-direction: column;
			align-items: flex-start;
			gap: 16px;
		}
	}

	.article-author {
		color: var(--base-color-text-subtitle-date);
		font-weight: 700;
		font-size: 18px;
		flex-grow: 1;
		display: flex;
		gap: 12px;
		align-items: center;
	}

	.article-author .avatar {
		border-radius: 100%;
		margin: 0;
	}

	.article-author .by {
		color: var(--base-color-text-subtitle);
	}

	.article-metadata .date {
		color: var(--base-color-text-subtitle-date);
	}

	.tag.active {
		filter: saturate(0.75);
	}

	@media screen and (min-width: 900px) {
		article .content {
			width: 70%;
			margin: auto;
		}
	}

	@media (max-width: 900px) {
		body {
			background-color: var(--base-color);
		}

		article {
			background-color: transparent;
			box-shadow: none;
		}

		article img:first-child,
		article video:first-child {
			max-width: 100%;
		}
	}
</style>

<link rel="stylesheet" href="/assets/css/highlight.obsidian.min.css">

<div class="container">
	<article class="padded">
		<div class="content article-container">
			<figure class="article-cover">
				

				<img src="/storage/app/uploads/public/5f8/6ec/9d7/5f86ec9d7d0fd694122636.png" title=""
					alt=" " class="rounded-lg"
					style="width: 100%; height: auto" />
			</figure>

			<div class="article-info">
				<h1>
					Complex text layouts progress report #1
				</h1>
				<div class="article-metadata">
					<div class="article-author">
						<span>By: </span>
						
						
							<img class="avatar" width="25" height="25" src="/assets/images/authors/default_avatar.svg" alt="Pāvels Nadtočajevs" loading="lazy">
						
						<span class="by">Pāvels Nadtočajevs</span>
					</div>
					<span class="date"> 14 October 2020</span>
				</div>

				<div class="tags">
					
					<a href="/blog/progress-report">
						<div class="tag active">Progress Report</div>
					</a>
					
				</div>
			</div>

			



	<div class="card card-warning">
		<p>
		
			This article is from <strong>October 2020</strong>, some of its contents might be outdated and no longer accurate.<br>
			You can find up-to-date information about the engine in the <a href="https://docs.godotengine.org/en/stable/">official documentation</a>.
		
		</p>
	</div>





			<div class="article-body">
				<h1 id="introduction">Introduction</h1>

<p>Hello! <a href="https://github.com/bruvzg">bruvzg</a> here, I got hired by the Godot team to work on the complex text layouts and BiDi aware UI implementation. This is the first part that focuses on TextServer API implementation.</p>

<p>See <a href="https://github.com/godotengine/godot-proposals/issues/1180">GH-1180</a>, <a href="https://github.com/godotengine/godot-proposals/issues/1181">GH-1181</a>, <a href="https://github.com/godotengine/godot-proposals/issues/1182">GH-1182</a>, <a href="https://github.com/godotengine/godot-proposals/issues/1183">GH-1183</a> on GitHub for detailed information on CTL proposals and feedback.</p>

<p>Currently, text display in Godot Engine is extremely limited, text is drawn character-by-character, left-to-right without kerning and support for any other font features.</p>

<p>Godot is incapable of correctly displaying text in the languages that are written right-to-left (e.g. Arabic, Hebrew), have context-sensitive characters (e.g. Arabic positional shape-forms) and ligatures or character reordering (e.g. Devanagari consonant placement).</p>

<h1 id="how-does-this-work">How does this work?</h1>

<p>Since Godot is game engine and CTL support is slower than simple text display and can (depending on the set of supported features) substantially increase the size of the exported project, and is not required for every game, CTL support is implemented as standalone <code class="language-plaintext highlighter-rouge">TextServer</code> module, that can be disabled, or easily moved to the GDNative library in the future.</p>

<p>Here’s <code class="language-plaintext highlighter-rouge">TextServer</code> API in the current state (API is not final and is subject to minor changes during further development): https://bruvzg.github.io/textserver-api-overview.html</p>

<h1 id="preparation-work">Preparation work</h1>

<p><code class="language-plaintext highlighter-rouge">wchar_t</code> type that was previously used by Godot to store Unicode string, is inconsistent and have different size on different platforms. Due to lack of UTF-16 surrogate pair support Godot was incapable to store and display character outside the basic multilingual plane (characters with the codes above <code class="language-plaintext highlighter-rouge">0xFFFF</code>, e.g. emojis) on Windows, where <code class="language-plaintext highlighter-rouge">wchar_t</code> is 16-bit.</p>

<p>For the ease of <code class="language-plaintext highlighter-rouge">TextServer</code> and GDNative interface development, Godot strings were changed to always use C++11 <code class="language-plaintext highlighter-rouge">char32_t</code> type and store string in UTF-32 encoding.
Additionally, fully functional (with surrogate pairs support) conversion to and from UTF-16 is implemented for use with Windows APIs.
All ASCII/Latin-1, UTF-8, UTF-16, and UTF-32 functions are exposed to GDNative and covered with unit tests.</p>

<h1 id="textserver-structure">TextServer structure</h1>

<p><img src="/storage/app/uploads/public/5f8/6e6/fe4/5f86e6fe4559f023119606.png" alt="TextServer structure overview" /></p>

<p>The new implementation introduces <code class="language-plaintext highlighter-rouge">TextServer</code> singleton, for low level handling of:</p>

<ul>
  <li>Fonts (loading font files, font substitution, and rendering text).</li>
  <li>Text processing for display:
    <ul>
      <li>Bi-directional reordering, using ICU library, with the optional override for highly structured texts (e.g. File path, URIs, and source code).</li>
      <li>Breaking text into uniform (with the same language, writing system, font and direction along whole text) runs (custom implementation, backed with ICU Unicode database API).</li>
      <li>Context-sensitive shaping (translation a string of character into a properly arranged sequence of glyphs, OpenType features), using HarfBuzz and SIL Graphite libraries.</li>
    </ul>
  </li>
  <li>Line breaking (custom implementation, optionally backed with ICU Break Iterator API).</li>
  <li>Text justification (fitting text to the desired width), using spaces and kashidas, (custom implementation, optionally backed with ICU Break Iterator API to break words in the languages without spaces between the words).</li>
  <li>Aligning text to the tab stops.</li>
  <li>Helper functions for the input controls:
    <ul>
      <li>Detection of selection/highlight rectangles in the bi-directional text.</li>
      <li>Split caret drawing (caret on the border of different direction runs).</li>
      <li>Caret movement over composite graphemes (composed of multiple combining characters).</li>
      <li>Hit testing for caret placement.</li>
    </ul>
  </li>
</ul>

<h1 id="current-textserver-implementations">Current TextServer implementations</h1>

<p>All text server implementations are fully interchangeable, project development with one text server can be easily switched to the different one without any changes to the code or resources. Changing text server in runtime is also possible but require reloading all themes and fonts, and refreshing all controls, therefore it’s not recommended.</p>

<h2 id="textserveradvanced">TextServerAdvanced</h2>

<p>ICU, HarfBuzz, and SIL Graphite backed text server.</p>

<p>Default text server with full CTL support, vertical text support (vertical text can be shaped and displayed by text server, but currently there’re no plans to support it in controls).</p>

<p><code class="language-plaintext highlighter-rouge">TextServerAdvanced</code> is capable of loading and using ICU break iterator database (4 MB). Break iterator database is included in the editor binary by default, and can be added to the exported project on demand, without rebuilding export templates.</p>

<p>Supports TrueType/OpenType (FreeType backed) and BMFont format fonts.</p>

<p><img src="/storage/app/uploads/public/5f8/6e2/612/5f86e2612931d380061737.png" alt="TextServerAdvanced Screenshot" />
<em><code class="language-plaintext highlighter-rouge">TextServerAdvanced</code> - with BiDi and shaping support.</em></p>

<h2 id="textserverfallback">TextServerFallback</h2>

<p>Simple, fallback text server without BiDi, shaping, OpenType font features and kashida justification support.</p>

<p><code class="language-plaintext highlighter-rouge">TextServerFallback</code> supports basic font features, like kerning, line breaking (using spaces to detect words), basic justification and have limited vertical text support.
Fallback text server is intended for use in the projects that do not need CTL support to avoid CTL overhead. Fallback text server can be used with Godot editor as well, in this case unsupported locales are automatically disabled.</p>

<p>Supports same font types as the <code class="language-plaintext highlighter-rouge">TextServerAdvanced</code>.</p>

<p><img src="/storage/app/uploads/public/5f8/6e2/bc6/5f86e2bc652b4356694485.png" alt="TextServerFallback Screenshot" />
<em><code class="language-plaintext highlighter-rouge">TextServerFallback</code> - No BiDi and contextual shaping.</em></p>

<h2 id="textservergdnative">TextServerGDNative</h2>

<p>Wrapper class for the GDNative text server implementations.</p>

<h2 id="reference-work">Reference work</h2>

<ul>
  <li>TextServer implementation proposal -  https://github.com/godotengine/godot-proposals/issues/1180</li>
  <li>UTF-32 transition - https://github.com/godotengine/godot/pull/40999  (merged to the master branch).</li>
  <li>Text server implementations - https://github.com/godotengine/godot/pull/41100 (first 4 commits, PR is regularly rebased to keep up with upstream changes, exact commit hashes may vary).</li>
  <li>BiDi and shaping process overview diagram - https://bruvzg.github.io/media/files/gdtl_operation_notes_1_shaping_draft.pdf</li>
  <li>Line breaking process overview diagram - https://bruvzg.github.io/media/files/gdtl_operation_notes_2_line_breaking_draft.pdf</li>
  <li>Line justification process overview diagram - https://bruvzg.github.io/media/files/gdtl_operation_notes_3_justification_draft.pdf</li>
  <li>GDNative library template - https://github.com/bruvzg/gdnative_text_server_template (dummy GDNative library implementation, intended as a base for future CoreText, DirectWrite based text servers or/and moving ICU/HarfBuzz based text server out of the core engine distribution).</li>
</ul>

<h2 id="additional-resources">Additional resources</h2>

<ul>
  <li>UAX #9: Unicode Bidirectional Algorithm - http://www.unicode.org/reports/tr9/</li>
  <li>Bidirectional text FAQ - http://www.unicode.org/faq/bidi.html</li>
  <li>ICU homepage - http://site.icu-project.org/</li>
  <li>HarfBuzz homepage - https://harfbuzz.github.io/</li>
  <li>SIL Graphite homepage - https://scripts.sil.org/cms/scripts/page.php?site_id=projects&amp;item_id=graphite_home</li>
  <li>Approaches to full justification - https://www.w3.org/International/articles/typography/justification</li>
  <li>Kashida expansion priorities - https://web.archive.org/web/20160304113846/http://www.microsoft.com/middleeast/msdn/JustifyingText-CSS.aspx</li>
</ul>

<h2 id="future">Future</h2>

<p>Stay tuned for the next progress report. Next part will focus on UI mirroring and related changes.</p>

			</div>
		</div>
	</article>
</div>

<link rel="stylesheet" href="/assets/css/anchor-link.css?1">
<link rel="stylesheet" href="/assets/css/article-cards.css?1">
<script src="/assets/js/anchor-link.js"></script>
<script>
	document.addEventListener('DOMContentLoaded', () => {
		// Add icons to easily copy section links.
		window.applyAnchorLinks('.article-body');

		// Add lightbox elements in blog articles for Tobii.
		document.querySelectorAll('.article-cover img, .article-body img').forEach((articleImg) => {
			if (articleImg.classList.contains('lightbox-ignore')) {
				return;
			}

			const lightbox = document.createElement('a');
			lightbox.href = articleImg.src;
			lightbox.classList.add('lightbox');
			lightbox.dataset.group = 'article';
			articleImg.parentNode.appendChild(lightbox);
			lightbox.appendChild(articleImg);
		});
	});
</script>

</main>

<footer>
	<div class="container flex footer-container">
		<div id="copyright">
			<p>
				© 2007-2023 Juan Linietsky, Ariel Manzur and <a
					href="https://github.com/godotengine/godot/blob/master/AUTHORS.md" target="_blank"
					rel="noopener">contributors</a>.<br>
				Hosted by the <a href="https://godot.foundation/" target="_blank" rel="noopener">Godot Foundation</a>.<br>
				Website <a href="https://github.com/godotengine/godot-website" target="_blank" rel="noopener">source code on  GitHub</a>.
			</p>
		</div>
		<div id="sitemap">
			<ul class="sitemap-group">
				<li><strong>Get Godot</strong></li>
				<li><a href="/download/windows" class="set-os-download-url">Download</a></li>
				<li><a href="https://editor.godotengine.org/releases/latest/">Web Editor</a></li>
				<li>&nbsp;</li>
				<li><strong>Public Relations</strong></li>
				<li><a href="/blog">Blog</a></li>
				<li><a href="/community">Communities and Events</a></li>
				<li><a href="/press">Press Kit</a></li>
			</ul>
			<ul class="sitemap-group">
				<li><strong>About Godot</strong></li>
				<li><a href="/features">Features</a></li>
				<li><a href="/showcase">Showcase</a></li>
				<li><a href="/education">Education</a></li>
				<li><a href="/license">License</a></li>
				<li><a href="/code-of-conduct">Code of Conduct</a></li>
				<li><a href="/privacy-policy">Privacy Policy</a></li>
				<li><a href="https://fund.godotengine.org">Donate</a></li>
			</ul>
			<ul class="sitemap-group">
				<li><strong>Project Team</strong></li>
				<li><a href="/governance">Governance</a></li>
				<li><a href="/teams">Teams</a></li>
				<li>&nbsp;</li>
				<li><strong>Extra Resources</strong></li>
				<li><a href="/asset-library/asset">Asset Library</a></li>
				<li><a href="https://docs.godotengine.org">Documentation</a></li>
				<li><a href="https://github.com/godotengine">Code Repository</a></li>
			</ul>
		</div>
		<div id="social" class="dark-desaturate">
			<h4 class="text-right"><a href="/contact">Contact us</a></h4>
			<div class="flex justify-space-between" style="gap: 3px;">
				<a href="https://github.com/godotengine" target="_blank" rel="noopener">
					<img src="/assets/footer/github_logo.svg" width="32" height="32" alt="GitHub">
				</a>
				<a href="https://mastodon.gamedev.place/@godotengine" target="_blank" rel="noopener">
					<img src="/assets/footer/mastodon_logo.svg" width="32" height="32" alt="Mastodon">
				</a>
				<a href="https://twitter.com/godotengine" target="_blank" rel="noopener">
					<img src="/assets/footer/twitter_logo.svg" width="32" height="32" alt="Twitter">
				</a>
				<a href="https://www.facebook.com/groups/godotengine/" target="_blank" rel="noopener">
					<img src="/assets/footer/facebook_logo.svg" width="32" height="32" alt="Facebook">
				</a>
				<a href="https://www.reddit.com/r/godot" target="_blank" rel="noopener">
					<!-- Zero-width space in the `alt` text to prevent content blockers from blocking the icon -->
					<img src="/assets/footer/reddit_logo.svg" width="32" height="32" alt="Red​dit">
				</a>
				<a href="/rss.xml" target="_blank" rel="noopener">
					<!-- Icon is called `feed` instead of `rss` to prevent content blockers from blocking the icon -->
					<img src="/assets/footer/feed_logo.svg" width="32" height="32" alt="RSS feed">
				</a>
			</div>
		</div>
	</div>
</footer>

<script defer src="/assets/js/tobii.min.js"></script>
<script defer src="/assets/js/highlight.min.js?1"></script>
<script defer src="/assets/js/highlight.gdscript.min.js?1"></script>
<script>
	document.addEventListener('DOMContentLoaded', () => {
		// This needs to be done on page load but also after page changes,
		// in case a code block appears in an article.
		document.querySelectorAll('pre code').forEach((block) => {
			hljs.highlightBlock(block);
		});

		// Initialize lightbox.
		new Tobii({
			zoom: false,
		});

		// Update any download link to point to identified user's OS.
		const links = document.querySelectorAll('.set-os-download-url');
		for (let i = 0; i < links.length; i++) {
			const link = links[i];
			let link_slug = 'download';
			if ('version' in link.dataset && link.dataset['version'] === '3') {
				link_slug = 'download/3.x';
			}

			let link_platform = 'windows';
			if (navigator.platform.indexOf('Mac') !== -1) {
				link_platform = 'macos';
			} else if (navigator.platform.indexOf('Linux') !== -1) {
				link_platform = 'linux';
			}

			link.href = `/${link_slug}/${link_platform}`;
		}
	});
</script>


</body>

</html>
